/* LibraryApp.java
   Single-file Library Management System (Swing + JDBC)
   Requirements:
     - MySQL database server running (user has privileges to DROP/CREATE if using Recreate DB)
     - MySQL Connector/J on classpath
   Author: ChatGPT (fixed + GUI enhancements)
*/

import javax.swing.*;
import javax.swing.table.*;
import java.awt.*;
import java.awt.event.*;
import java.sql.*;
import java.time.LocalDate;
import java.util.*;
import java.util.List;
import java.util.concurrent.ExecutionException;
import java.util.regex.Pattern;
import java.sql.Date; 


public class LibraryApp extends JFrame {

    // EDIT THESE to match your MySQL credentials
    private static final String DB_URL = "jdbc:mysql://localhost:3306/library_db?useSSL=false&serverTimezone=UTC";
    private static final String DB_URL_SERVER = "jdbc:mysql://localhost:3306/?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC";
    private static final String DB_USER = "root";
    private static final String DB_PASS = "Rahul@2005";

    // DAOs
    private final BookDAO bookDAO;
    private final MemberDAO memberDAO;
    private final BorrowDAO borrowDAO;

    // GUI components
    private JTable bookTable, memberTable, borrowTable;
    private DefaultTableModel bookTableModel, memberTableModel, borrowTableModel;
    private JTextField bookSearchField, memberSearchField;
    private JButton addBookBtn, addMemberBtn, issueBtn, returnBtn, refreshBtn;
    private JLabel statusBar;

    public LibraryApp() {
        super("Library Management System");
        this.bookDAO = new BookDAO(DB_URL, DB_USER, DB_PASS);
        this.memberDAO = new MemberDAO(DB_URL, DB_USER, DB_PASS);
        this.borrowDAO = new BorrowDAO(DB_URL, DB_USER, DB_PASS);

        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(1100, 720);
        setLocationRelativeTo(null);
        initUI();
        loadAllData();
    }

    private void initUI() {
        // Toolbar
        JToolBar toolbar = new JToolBar();
        JButton btnRecreateDB = new JButton("Recreate DB");
        btnRecreateDB.setToolTipText("Drop and recreate database (DESTROYS existing data)");
        btnRecreateDB.addActionListener(e -> recreateDatabaseAction());
        JButton btnExportCSV = new JButton("Export Books CSV");
        btnExportCSV.addActionListener(e -> exportBooksCsv());
        toolbar.add(btnRecreateDB);
        toolbar.addSeparator();
        toolbar.add(btnExportCSV);

        add(toolbar, BorderLayout.NORTH);

        // Tabs
        JTabbedPane tabs = new JTabbedPane();

        // Books Panel
        JPanel booksPanel = new JPanel(new BorderLayout(6,6));
        bookSearchField = new JTextField();
        JButton searchBookBtn = new JButton("Search Books");
        searchBookBtn.addActionListener(e -> searchBooks());
        JPanel topBooks = new JPanel(new BorderLayout(4,4));
        topBooks.add(new JLabel("Search (title/author/isbn): "), BorderLayout.WEST);
        topBooks.add(bookSearchField, BorderLayout.CENTER);
        topBooks.add(searchBookBtn, BorderLayout.EAST);
        booksPanel.add(topBooks, BorderLayout.NORTH);

        String[] bookCols = {"ID","Title","Author","ISBN","Total","Available"};
        bookTableModel = new DefaultTableModel(bookCols, 0) {
            public boolean isCellEditable(int r, int c) { return false; }
        };
        bookTable = new JTable(bookTableModel);
        bookTable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        bookTable.setAutoCreateRowSorter(true);
        // double-click to edit
        bookTable.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                if (e.getClickCount() == 2) {
                    int r = bookTable.getSelectedRow();
                    if (r != -1) {
                        int modelRow = bookTable.convertRowIndexToModel(r);
                        int id = (int)bookTableModel.getValueAt(modelRow, 0);
                        try {
                            Book b = bookDAO.findById(id);
                            if (b != null) showBookDialog(b);
                        } catch (Exception ex) { showError(ex); }
                    }
                }
            }
        });
        booksPanel.add(new JScrollPane(bookTable), BorderLayout.CENTER);

        JPanel bookButtons = new JPanel();
        addBookBtn = new JButton("Add Book");
        addBookBtn.addActionListener(e -> showBookDialog(null));
        JButton editBookBtn = new JButton("Edit Book");
        editBookBtn.addActionListener(e -> editSelectedBook());
        JButton deleteBookBtn = new JButton("Delete Book");
        deleteBookBtn.addActionListener(e -> deleteSelectedBook());
        bookButtons.add(addBookBtn);
        bookButtons.add(editBookBtn);
        bookButtons.add(deleteBookBtn);
        booksPanel.add(bookButtons, BorderLayout.SOUTH);

        // Members Panel
        JPanel membersPanel = new JPanel(new BorderLayout(6,6));
        memberSearchField = new JTextField();
        JButton searchMemberBtn = new JButton("Search Members");
        searchMemberBtn.addActionListener(e -> searchMembers());
        JPanel topMembers = new JPanel(new BorderLayout(4,4));
        topMembers.add(new JLabel("Search (name/email): "), BorderLayout.WEST);
        topMembers.add(memberSearchField, BorderLayout.CENTER);
        topMembers.add(searchMemberBtn, BorderLayout.EAST);
        membersPanel.add(topMembers, BorderLayout.NORTH);

        String[] memberCols = {"ID","Name","Email","Mobile"};
        memberTableModel = new DefaultTableModel(memberCols, 0) {
            public boolean isCellEditable(int r,int c){ return false; }
        };
        memberTable = new JTable(memberTableModel);
        memberTable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        memberTable.setAutoCreateRowSorter(true);
        memberTable.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                if (e.getClickCount() == 2) {
                    int r = memberTable.getSelectedRow();
                    if (r != -1) {
                        int modelRow = memberTable.convertRowIndexToModel(r);
                        int id = (int)memberTableModel.getValueAt(modelRow, 0);
                        try {
                            Member m = memberDAO.findById(id);
                            if (m != null) showMemberDialog(m);
                        } catch (Exception ex) { showError(ex); }
                    }
                }
            }
        });
        membersPanel.add(new JScrollPane(memberTable), BorderLayout.CENTER);

        JPanel memberButtons = new JPanel();
        addMemberBtn = new JButton("Add Member");
        addMemberBtn.addActionListener(e -> showMemberDialog(null));
        JButton editMemberBtn = new JButton("Edit Member");
        editMemberBtn.addActionListener(e -> editSelectedMember());
        JButton deleteMemberBtn = new JButton("Delete Member");
        deleteMemberBtn.addActionListener(e -> deleteSelectedMember());
        memberButtons.add(addMemberBtn);
        memberButtons.add(editMemberBtn);
        memberButtons.add(deleteMemberBtn);
        membersPanel.add(memberButtons, BorderLayout.SOUTH);

        // Borrow Panel
        JPanel borrowPanel = new JPanel(new BorderLayout(6,6));
        JPanel borrowTop = new JPanel();
        issueBtn = new JButton("Issue Book to Member");
        issueBtn.addActionListener(e -> issueBook());
        returnBtn = new JButton("Return Selected Borrow");
        returnBtn.addActionListener(e -> returnBook());
        refreshBtn = new JButton("Refresh All");
        refreshBtn.addActionListener(e -> loadAllData());
        borrowTop.add(issueBtn);
        borrowTop.add(returnBtn);
        borrowTop.add(refreshBtn);
        borrowPanel.add(borrowTop, BorderLayout.NORTH);

        String[] borrowCols = {"ID","Book Title","Member Name","Borrow Date","Return Date","Returned"};
        borrowTableModel = new DefaultTableModel(borrowCols, 0) {
            public boolean isCellEditable(int r,int c){ return false; }
        };
        borrowTable = new JTable(borrowTableModel);
        borrowTable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        borrowTable.setAutoCreateRowSorter(true);
        borrowPanel.add(new JScrollPane(borrowTable), BorderLayout.CENTER);

        // Add tabs
        tabs.addTab("Books", booksPanel);
        tabs.addTab("Members", membersPanel);
        tabs.addTab("Borrow/Return", borrowPanel);
        add(tabs, BorderLayout.CENTER);

        // Status bar
        statusBar = new JLabel("Ready");
        statusBar.setBorder(BorderFactory.createEmptyBorder(4,6,4,6));
        add(statusBar, BorderLayout.SOUTH);
    }

    /* -------------------------
       Data loading & operations
       ------------------------- */

    private void loadAllData() {
        setStatus("Loading data...");
        new SwingWorker<Void,Void>(){
            List<Book> books;
            List<Member> members;
            List<BorrowRecord> borrows;
            protected Void doInBackground() throws Exception {
                books = bookDAO.getAll();
                members = memberDAO.getAll();
                borrows = borrowDAO.getAllWithDetails();
                return null;
            }
            protected void done() {
                try {
                    get(); // propagate exceptions
                    refreshBookTable(books);
                    refreshMemberTable(members);
                    refreshBorrowTable(borrows);
                    setStatus("Data loaded");
                } catch (InterruptedException | ExecutionException ex) {
                    showError(ex.getCause());
                    setStatus("Failed to load data");
                }
            }
        }.execute();
    }

    private void searchBooks() {
        String q = bookSearchField.getText().trim();
        setStatus("Searching books...");
        new SwingWorker<List<Book>,Void>(){
            protected List<Book> doInBackground() throws Exception {
                if (q.isEmpty()) return bookDAO.getAll();
                return bookDAO.search(q);
            }
            protected void done() {
                try {
                    refreshBookTable(get());
                    setStatus("Search complete");
                } catch (Exception ex) { showError(ex); setStatus("Search failed"); }
            }
        }.execute();
    }

    private void searchMembers() {
        String q = memberSearchField.getText().trim();
        setStatus("Searching members...");
        new SwingWorker<List<Member>,Void>(){
            protected List<Member> doInBackground() throws Exception {
                if (q.isEmpty()) return memberDAO.getAll();
                return memberDAO.search(q);
            }
            protected void done() {
                try {
                    refreshMemberTable(get());
                    setStatus("Search complete");
                } catch (Exception ex) { showError(ex); setStatus("Search failed"); }
            }
        }.execute();
    }

    private void refreshBookTable(List<Book> books) {
        SwingUtilities.invokeLater(() -> {
            bookTableModel.setRowCount(0);
            for (Book b : books) {
                bookTableModel.addRow(new Object[]{b.getId(), b.getTitle(), b.getAuthor(), b.getIsbn(), b.getTotalCopies(), b.getAvailableCopies()});
            }
        });
    }

    private void refreshMemberTable(List<Member> members) {
        SwingUtilities.invokeLater(() -> {
            memberTableModel.setRowCount(0);
            for (Member m : members) {
                memberTableModel.addRow(new Object[]{m.getId(), m.getName(), m.getEmail(), m.getMobile()});
            }
        });
    }

    private void refreshBorrowTable(List<BorrowRecord> borrows) {
        SwingUtilities.invokeLater(() -> {
            borrowTableModel.setRowCount(0);
            for (BorrowRecord r : borrows) {
                String returnDate = r.getReturnDate() == null ? "" : r.getReturnDate().toString();
                borrowTableModel.addRow(new Object[]{r.getId(), r.getBookTitle(), r.getMemberName(), r.getBorrowDate().toString(), returnDate, r.isReturned()});
            }
        });
    }

    private void showBookDialog(Book existing) {
        JTextField title = new JTextField(existing == null ? "" : existing.getTitle());
        JTextField author = new JTextField(existing == null ? "" : existing.getAuthor());
        JTextField isbn = new JTextField(existing == null ? "" : existing.getIsbn());
        JTextField total = new JTextField(existing == null ? "1" : String.valueOf(existing.getTotalCopies()));
        JPanel p = new JPanel(new GridLayout(0,1,4,4));
        p.add(new JLabel("Title:")); p.add(title);
        p.add(new JLabel("Author:")); p.add(author);
        p.add(new JLabel("ISBN (optional):")); p.add(isbn);
        p.add(new JLabel("Total copies:")); p.add(total);

        int ok = JOptionPane.showConfirmDialog(this, p, (existing==null ? "Add Book":"Edit Book"), JOptionPane.OK_CANCEL_OPTION);
        if (ok != JOptionPane.OK_OPTION) return;
        try {
            String tTitle = title.getText().trim();
            if (tTitle.isEmpty()) { JOptionPane.showMessageDialog(this, "Title required"); return; }
            int tot = Integer.parseInt(total.getText().trim());
            if (tot < 1) throw new NumberFormatException("Total copies must be >= 1");
            String tAuthor = author.getText().trim();
            String tIsbn = isbn.getText().trim();
            if (!tIsbn.isEmpty() && tIsbn.length() > 50) { JOptionPane.showMessageDialog(this, "ISBN too long"); return; }

            if (existing == null) {
                Book b = new Book(0, tTitle, tAuthor, tIsbn, tot, tot);
                bookDAO.create(b);
                setStatus("Book added");
            } else {
                existing.setTitle(tTitle);
                existing.setAuthor(tAuthor);
                existing.setIsbn(tIsbn);
                // Adjust available by difference in total
                int diff = tot - existing.getTotalCopies();
                existing.setTotalCopies(tot);
                existing.setAvailableCopies(Math.max(0, existing.getAvailableCopies() + diff));
                bookDAO.update(existing);
                setStatus("Book updated");
            }
            loadAllData();
        } catch (Exception ex) {
            showError(ex);
        }
    }

    private void showMemberDialog(Member existing) {
        JTextField name = new JTextField(existing == null ? "" : existing.getName());
        JTextField email = new JTextField(existing == null ? "" : existing.getEmail());
        JTextField mobile = new JTextField(existing == null ? "" : existing.getMobile());
        JPanel p = new JPanel(new GridLayout(0,1,4,4));
        p.add(new JLabel("Name:")); p.add(name);
        p.add(new JLabel("Email (optional):")); p.add(email);
        p.add(new JLabel("Mobile (optional):")); p.add(mobile);

        int ok = JOptionPane.showConfirmDialog(this, p, (existing==null ? "Add Member":"Edit Member"), JOptionPane.OK_CANCEL_OPTION);
        if (ok != JOptionPane.OK_OPTION) return;
        try {
            String tName = name.getText().trim();
            if (tName.isEmpty()) { JOptionPane.showMessageDialog(this, "Name required"); return; }
            String tEmail = email.getText().trim();
            if (!tEmail.isEmpty() && !isValidEmail(tEmail)) { JOptionPane.showMessageDialog(this, "Invalid email"); return; }
            String tMobile = mobile.getText().trim();
            if (!tMobile.isEmpty() && tMobile.length() > 50) { JOptionPane.showMessageDialog(this, "Mobile too long"); return; }

            if (existing == null) {
                Member m = new Member(0, tName, tEmail, tMobile);
                memberDAO.create(m);
                setStatus("Member added");
            } else {
                existing.setName(tName);
                existing.setEmail(tEmail);
                existing.setMobile(tMobile);
                memberDAO.update(existing);
                setStatus("Member updated");
            }
            loadAllData();
        } catch (Exception ex) {
            showError(ex);
        }
    }

    private void deleteSelectedBook() {
        int r = bookTable.getSelectedRow();
        if (r == -1) { JOptionPane.showMessageDialog(this,"Select a book first"); return; }
        int modelRow = bookTable.convertRowIndexToModel(r);
        int id = (int)bookTableModel.getValueAt(modelRow,0);
        int confirm = JOptionPane.showConfirmDialog(this,"Delete book id="+id+" ? This will also delete related borrow records.","Confirm",JOptionPane.YES_NO_OPTION);
        if (confirm != JOptionPane.YES_OPTION) return;
        try { bookDAO.delete(id); loadAllData(); setStatus("Book deleted"); }
        catch(Exception ex) { showError(ex); }
    }

    private void deleteSelectedMember() {
        int r = memberTable.getSelectedRow();
        if (r == -1) { JOptionPane.showMessageDialog(this,"Select a member first"); return; }
        int modelRow = memberTable.convertRowIndexToModel(r);
        int id = (int)memberTableModel.getValueAt(modelRow,0);
        int confirm = JOptionPane.showConfirmDialog(this,"Delete member id="+id+" ? This will also delete related borrow records.","Confirm",JOptionPane.YES_NO_OPTION);
        if (confirm != JOptionPane.YES_OPTION) return;
        try { memberDAO.delete(id); loadAllData(); setStatus("Member deleted"); }
        catch(Exception ex) { showError(ex); }
    }

    private void editSelectedBook() {
        int r = bookTable.getSelectedRow();
        if (r == -1) { JOptionPane.showMessageDialog(this,"Select a book to edit"); return; }
        int modelRow = bookTable.convertRowIndexToModel(r);
        int id = (int)bookTableModel.getValueAt(modelRow,0);
        try {
            Book b = bookDAO.findById(id);
            if (b != null) showBookDialog(b);
        } catch (Exception ex) { showError(ex); }
    }

    private void editSelectedMember() {
        int r = memberTable.getSelectedRow();
        if (r == -1) { JOptionPane.showMessageDialog(this,"Select a member to edit"); return; }
        int modelRow = memberTable.convertRowIndexToModel(r);
        int id = (int)memberTableModel.getValueAt(modelRow,0);
        try {
            Member m = memberDAO.findById(id);
            if (m != null) showMemberDialog(m);
        } catch (Exception ex) { showError(ex); }
    }

    private void issueBook() {
        // pick a book and a member
        int br = bookTable.getSelectedRow();
        int mr = memberTable.getSelectedRow();
        if (br == -1 || mr == -1) {
            JOptionPane.showMessageDialog(this, "Select a book and a member (in their respective tabs) before issuing.");
            return;
        }
        int bookModelRow = bookTable.convertRowIndexToModel(br);
        int memberModelRow = memberTable.convertRowIndexToModel(mr);
        int bookId = (int)bookTableModel.getValueAt(bookModelRow,0);
        int memberId = (int)memberTableModel.getValueAt(memberModelRow,0);

        try {
            borrowDAO.issueBook(bookId, memberId);
            JOptionPane.showMessageDialog(this, "Book issued successfully.");
            setStatus("Book issued");
            loadAllData();
        } catch (Exception ex) { showError(ex); setStatus("Issue failed"); }
    }

    private void returnBook() {
        int r = borrowTable.getSelectedRow();
        if (r == -1) { JOptionPane.showMessageDialog(this,"Select a borrow record to return."); return; }
        int modelRow = borrowTable.convertRowIndexToModel(r);
        int borrowId = (int)borrowTableModel.getValueAt(modelRow,0);
        try {
            borrowDAO.returnBook(borrowId);
            JOptionPane.showMessageDialog(this,"Book returned.");
            setStatus("Book returned");
            loadAllData();
        } catch (Exception ex) { showError(ex); setStatus("Return failed"); }
    }

    private void showError(Throwable t) {
        // Print stack for debug
        t.printStackTrace();
        String msg = t == null ? "Unknown error" : (t.getMessage() == null ? t.toString() : t.getMessage());
        JOptionPane.showMessageDialog(this, "Error: " + msg, "Error", JOptionPane.ERROR_MESSAGE);
    }

    private void setStatus(String s) {
        SwingUtilities.invokeLater(() -> statusBar.setText(s));
    }

    public static void main(String[] args) {
        // Ensure driver loaded (modern drivers auto-register, but explicit load is harmless)
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException ignored) {}
        SwingUtilities.invokeLater(() -> {
            LibraryApp app = new LibraryApp();
            app.setVisible(true);
        });
    }

    /* ===========================
       Domain classes & interfaces
       =========================== */

    interface Repository<T> {
        T create(T t) throws Exception;
        T update(T t) throws Exception;
        boolean delete(int id) throws Exception;
        T findById(int id) throws Exception;
        List<T> getAll() throws Exception;
    }

    static class Person {
        private int id;
        private String name;
        Person(int id, String name) { this.id = id; this.name = name; }
        public int getId(){ return id; }
        public String getName(){ return name; }
        public void setName(String name){ this.name = name; }
    }

    static class Member extends Person {
        private String email, mobile;
        Member(int id, String name, String email, String mobile) {
            super(id, name);
            this.email = email; this.mobile = mobile;
        }
        public String getEmail(){ return email; }
        public void setEmail(String e){ this.email = e; }
        public String getMobile(){ return mobile; }
        public void setMobile(String m){ this.mobile = m; }
    }

    static class Book {
        private int id;
        private String title, author, isbn;
        private int totalCopies, availableCopies;
        Book(int id, String title, String author, String isbn, int totalCopies, int availableCopies) {
            this.id = id; this.title = title; this.author = author; this.isbn = isbn;
            this.totalCopies = totalCopies; this.availableCopies = availableCopies;
        }
        public int getId(){ return id; }
        public String getTitle(){ return title; }
        public String getAuthor(){ return author; }
        public String getIsbn(){ return isbn; }
        public int getTotalCopies(){ return totalCopies; }
        public int getAvailableCopies(){ return availableCopies; }
        public void setTitle(String t){ this.title = t; }
        public void setAuthor(String a){ this.author = a; }
        public void setIsbn(String i){ this.isbn = i; }
        public void setTotalCopies(int n){ this.totalCopies = n; }
        public void setAvailableCopies(int n){ this.availableCopies = n; }
    }

    static class BorrowRecord {
        private int id;
        private int bookId, memberId;
        private LocalDate borrowDate;
        private LocalDate returnDate;
        private boolean returned;
        private String bookTitle;
        private String memberName;

        BorrowRecord(int id,int book,int member,LocalDate b,LocalDate r, boolean returned) {
            this.id=id; this.bookId=book; this.memberId=member; this.borrowDate=b; this.returnDate=r; this.returned=returned;
        }
        public int getId(){ return id; }
        public int getBookId(){ return bookId; }
        public int getMemberId(){ return memberId; }
        public LocalDate getBorrowDate(){ return borrowDate; }
        public LocalDate getReturnDate(){ return returnDate; }
        public boolean isReturned(){ return returned; }
        public String getBookTitle(){ return bookTitle; }
        public void setBookTitle(String s){ this.bookTitle = s; }
        public String getMemberName(){ return memberName; }
        public void setMemberName(String s){ this.memberName = s; }
    }

    /* ===========================
       DAO implementations (JDBC)
       =========================== */

    static class DB {
        private final String url, user, pass;
        DB(String url,String user,String pass){ this.url=url; this.user=user; this.pass=pass; }
        Connection getConnection() throws SQLException {
            return DriverManager.getConnection(url, user, pass);
        }
    }

    class BookDAO implements Repository<Book> {
        private final DB db;
        BookDAO(String url,String u,String p){ db = new DB(url,u,p); }

        public Book create(Book b) throws Exception {
            String sql = "INSERT INTO books (title,author,isbn,total_copies,available_copies) VALUES (?,?,?,?,?)";
            try (Connection c = db.getConnection();
                 PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
                ps.setString(1, b.getTitle());
                ps.setString(2, b.getAuthor());
                ps.setString(3, b.getIsbn());
                ps.setInt(4, b.getTotalCopies());
                ps.setInt(5, b.getAvailableCopies());
                ps.executeUpdate();
                try (ResultSet rs = ps.getGeneratedKeys()) {
                    if (rs.next()) {
                        int id = rs.getInt(1);
                        return new Book(id, b.getTitle(), b.getAuthor(), b.getIsbn(), b.getTotalCopies(), b.getAvailableCopies());
                    }
                }
            }
            throw new Exception("Failed to create book");
        }

        public Book update(Book b) throws Exception {
            String sql = "UPDATE books SET title=?,author=?,isbn=?,total_copies=?,available_copies=? WHERE id=?";
            try (Connection c = db.getConnection();
                 PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setString(1, b.getTitle());
                ps.setString(2, b.getAuthor());
                ps.setString(3, b.getIsbn());
                ps.setInt(4, b.getTotalCopies());
                ps.setInt(5, b.getAvailableCopies());
                ps.setInt(6, b.getId());
                int updated = ps.executeUpdate();
                if (updated == 1) return b;
            }
            throw new Exception("Failed to update book id="+b.getId());
        }

        public boolean delete(int id) throws Exception {
            String sql = "DELETE FROM books WHERE id=?";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setInt(1,id); return ps.executeUpdate()==1;
            }
        }

        public Book findById(int id) throws Exception {
            String sql = "SELECT * FROM books WHERE id=?";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setInt(1,id);
                try (ResultSet rs = ps.executeQuery()) {
                    if (rs.next()) {
                        return extractBook(rs);
                    }
                }
            }
            return null;
        }

        public List<Book> getAll() throws Exception {
            List<Book> list = new ArrayList<>();
            String sql = "SELECT * FROM books ORDER BY id";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql);
                 ResultSet rs = ps.executeQuery()) {
                while (rs.next()) list.add(extractBook(rs));
            }
            return list;
        }

        public List<Book> search(String q) throws Exception {
            List<Book> list = new ArrayList<>();
            String sql = "SELECT * FROM books WHERE title LIKE ? OR author LIKE ? OR isbn LIKE ? ORDER BY id";
            String p = "%" + q + "%";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setString(1,p); ps.setString(2,p); ps.setString(3,p);
                try (ResultSet rs = ps.executeQuery()) {
                    while (rs.next()) list.add(extractBook(rs));
                }
            }
            return list;
        }

        private Book extractBook(ResultSet rs) throws SQLException {
            return new Book(
                rs.getInt("id"),
                rs.getString("title"),
                rs.getString("author"),
                rs.getString("isbn"),
                rs.getInt("total_copies"),
                rs.getInt("available_copies")
            );
        }
    }

    class MemberDAO implements Repository<Member> {
        private final DB db;
        MemberDAO(String url,String u,String p){ db = new DB(url,u,p); }

        public Member create(Member m) throws Exception {
            String sql = "INSERT INTO members (name,email,mobile) VALUES (?,?,?)";
            try (Connection c = db.getConnection();
                 PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
                ps.setString(1, m.getName());
                ps.setString(2, m.getEmail());
                ps.setString(3, m.getMobile());
                ps.executeUpdate();
                try (ResultSet rs = ps.getGeneratedKeys()) {
                    if (rs.next()) return new Member(rs.getInt(1), m.getName(), m.getEmail(), m.getMobile());
                }
            }
            throw new Exception("Failed to create member");
        }

        public Member update(Member m) throws Exception {
            String sql = "UPDATE members SET name=?,email=?,mobile=? WHERE id=?";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setString(1, m.getName());
                ps.setString(2, m.getEmail());
                ps.setString(3, m.getMobile());
                ps.setInt(4, m.getId());
                int updated = ps.executeUpdate();
                if (updated == 1) return m;
            }
            throw new Exception("Failed to update member id="+m.getId());
        }

        public boolean delete(int id) throws Exception {
            String sql = "DELETE FROM members WHERE id=?";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setInt(1,id); return ps.executeUpdate()==1;
            }
        }

        public Member findById(int id) throws Exception {
            String sql = "SELECT * FROM members WHERE id=?";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setInt(1,id);
                try (ResultSet rs = ps.executeQuery()) {
                    if (rs.next()) {
                        return extractMember(rs);
                    }
                }
            }
            return null;
        }

        public List<Member> getAll() throws Exception {
            List<Member> list = new ArrayList<>();
            String sql = "SELECT * FROM members ORDER BY id";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql);
                 ResultSet rs = ps.executeQuery()) {
                while (rs.next()) list.add(extractMember(rs));
            }
            return list;
        }

        public List<Member> search(String q) throws Exception {
            List<Member> list = new ArrayList<>();
            String sql = "SELECT * FROM members WHERE name LIKE ? OR email LIKE ? ORDER BY id";
            String p = "%" + q + "%";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setString(1,p); ps.setString(2,p);
                try (ResultSet rs = ps.executeQuery()) {
                    while (rs.next()) list.add(extractMember(rs));
                }
            }
            return list;
        }

        private Member extractMember(ResultSet rs) throws SQLException {
            return new Member(rs.getInt("id"), rs.getString("name"), rs.getString("email"), rs.getString("mobile"));
        }
    }

    class BorrowDAO {
        private final DB db;
        BorrowDAO(String url,String u,String p){ db = new DB(url,u,p); }

        public BorrowRecord create(BorrowRecord r) throws Exception {
            String sql = "INSERT INTO borrow_records (book_id, member_id, borrow_date, return_date, returned) VALUES (?,?,?,?,?)";
            try (Connection c = db.getConnection();
                 PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
                ps.setInt(1, r.getBookId());
                ps.setInt(2, r.getMemberId());
                ps.setDate(3, Date.valueOf(r.getBorrowDate()));
                if (r.getReturnDate() == null) ps.setNull(4, Types.DATE);
                else ps.setDate(4, Date.valueOf(r.getReturnDate()));
                ps.setBoolean(5, r.isReturned());
                ps.executeUpdate();
                try (ResultSet rs = ps.getGeneratedKeys()) {
                    if (rs.next()) {
                        return new BorrowRecord(rs.getInt(1), r.getBookId(), r.getMemberId(), r.getBorrowDate(), r.getReturnDate(), r.isReturned());
                    }
                }
            }
            throw new Exception("Failed to create borrow record");
        }

        public BorrowRecord findById(int id) throws Exception {
            String sql = "SELECT * FROM borrow_records WHERE id=?";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql)) {
                ps.setInt(1,id);
                try (ResultSet rs = ps.executeQuery()) {
                    if (rs.next()) {
                        return extractBorrow(rs);
                    }
                }
            }
            return null;
        }

        public List<BorrowRecord> getAll() throws Exception {
            List<BorrowRecord> list = new ArrayList<>();
            String sql = "SELECT * FROM borrow_records ORDER BY id DESC";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql);
                 ResultSet rs = ps.executeQuery()) {
                while (rs.next()) list.add(extractBorrow(rs));
            }
            return list;
        }

        public List<BorrowRecord> getAllWithDetails() throws Exception {
            List<BorrowRecord> list = new ArrayList<>();
            String sql = "SELECT br.*, b.title AS book_title, m.name AS member_name FROM borrow_records br " +
                    "JOIN books b ON br.book_id = b.id JOIN members m ON br.member_id = m.id ORDER BY br.id DESC";
            try (Connection c = db.getConnection(); PreparedStatement ps = c.prepareStatement(sql);
                 ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    BorrowRecord r = extractBorrow(rs);
                    r.setBookTitle(rs.getString("book_title"));
                    r.setMemberName(rs.getString("member_name"));
                    list.add(r);
                }
            }
            return list;
        }

        private BorrowRecord extractBorrow(ResultSet rs) throws SQLException {
            Date bd = rs.getDate("borrow_date");
            Date rd = rs.getDate("return_date");
            BorrowRecord r = new BorrowRecord(
                    rs.getInt("id"),
                    rs.getInt("book_id"),
                    rs.getInt("member_id"),
                    bd == null ? LocalDate.now() : bd.toLocalDate(),
                    rd == null ? null : rd.toLocalDate(),
                    rs.getBoolean("returned")
            );
            return r;
        }

        public void issueBook(int bookId, int memberId) throws Exception {
            String insertSql = "INSERT INTO borrow_records (book_id, member_id, borrow_date, returned) VALUES (?, ?, ?, ?)";
            try (Connection c = db.getConnection()) {
                c.setAutoCommit(false);
                try {
                    String sel = "SELECT available_copies FROM books WHERE id=? FOR UPDATE";
                    try (PreparedStatement ps1 = c.prepareStatement(sel)) {
                        ps1.setInt(1, bookId);
                        try (ResultSet rs = ps1.executeQuery()) {
                            if (!rs.next()) throw new SQLException("Book not found");
                            int avail = rs.getInt(1);
                            if (avail <= 0) throw new SQLException("No copies available");
                        }
                    }
                    try (PreparedStatement ps2 = c.prepareStatement("UPDATE books SET available_copies=available_copies-1 WHERE id=?")) {
                        ps2.setInt(1, bookId);
                        if (ps2.executeUpdate() != 1) throw new SQLException("Failed to decrement available copies");
                    }
                    try (PreparedStatement ps3 = c.prepareStatement(insertSql)) {
                        ps3.setInt(1, bookId);
                        ps3.setInt(2, memberId);
                        ps3.setDate(3, Date.valueOf(LocalDate.now()));
                        ps3.setBoolean(4, false);
                        ps3.executeUpdate();
                    }
                    c.commit();
                } catch (Exception ex) {
                    c.rollback();
                    throw ex;
                } finally {
                    c.setAutoCommit(true);
                }
            }
        }

        public void returnBook(int borrowId) throws Exception {
            String sel = "SELECT book_id, returned FROM borrow_records WHERE id=? FOR UPDATE";
            try (Connection c = db.getConnection()) {
                c.setAutoCommit(false);
                try {
                    int bookId;
                    boolean returned;
                    try (PreparedStatement ps = c.prepareStatement(sel)) {
                        ps.setInt(1, borrowId);
                        try (ResultSet rs = ps.executeQuery()) {
                            if (!rs.next()) throw new SQLException("Borrow record not found");
                            bookId = rs.getInt("book_id");
                            returned = rs.getBoolean("returned");
                        }
                    }
                    if (returned) throw new SQLException("Book already returned");

                    try (PreparedStatement ps2 = c.prepareStatement("UPDATE borrow_records SET returned=TRUE, return_date=? WHERE id=?")) {
                        ps2.setDate(1, Date.valueOf(LocalDate.now()));
                        ps2.setInt(2, borrowId);
                        if (ps2.executeUpdate() != 1) throw new SQLException("Failed to update borrow record");
                    }

                    try (PreparedStatement ps3 = c.prepareStatement("UPDATE books SET available_copies=available_copies+1 WHERE id=?")) {
                        ps3.setInt(1, bookId);
                        if (ps3.executeUpdate() != 1) {
                            throw new SQLException("Failed to increment book available copies");
                        }
                    }
                    c.commit();
                } catch (Exception ex) {
                    c.rollback();
                    throw ex;
                } finally {
                    c.setAutoCommit(true);
                }
            }
        }
    }

    /* ---------------------------
       Utility actions (DB create/drop + CSV export)
       --------------------------- */

    private void recreateDatabaseAction() {
        int confirm = JOptionPane.showConfirmDialog(this,
                "This will DROP the database 'library_db' if it exists and recreate it (ALL DATA WILL BE LOST).\nAre you sure?",
                "Confirm Recreate Database",
                JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE);
        if (confirm != JOptionPane.YES_OPTION) return;

        setStatus("Recreating database...");
        new SwingWorker<Void, Void>() {
            protected Void doInBackground() throws Exception {
                executeSqlOnServer(
                        "DROP DATABASE IF EXISTS library_db;",
                        "CREATE DATABASE library_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;",
                        "USE library_db;",
                        "CREATE TABLE books (\n" +
                                "  id INT AUTO_INCREMENT PRIMARY KEY,\n" +
                                "  title VARCHAR(255) NOT NULL,\n" +
                                "  author VARCHAR(255),\n" +
                                "  isbn VARCHAR(50) UNIQUE,\n" +
                                "  total_copies INT NOT NULL DEFAULT 1,\n" +
                                "  available_copies INT NOT NULL DEFAULT 1\n" +
                                ");",
                        "CREATE TABLE members (\n" +
                                "  id INT AUTO_INCREMENT PRIMARY KEY,\n" +
                                "  name VARCHAR(200) NOT NULL,\n" +
                                "  email VARCHAR(200) UNIQUE,\n" +
                                "  mobile VARCHAR(50)\n" +
                                ");",
                        "CREATE TABLE borrow_records (\n" +
                                "  id INT AUTO_INCREMENT PRIMARY KEY,\n" +
                                "  book_id INT NOT NULL,\n" +
                                "  member_id INT NOT NULL,\n" +
                                "  borrow_date DATE NOT NULL,\n" +
                                "  return_date DATE,\n" +
                                "  returned BOOLEAN NOT NULL DEFAULT FALSE,\n" +
                                "  FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE,\n" +
                                "  FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE\n" +
                                ");"
                );
                return null;
            }
            protected void done() {
                try {
                    get();
                    setStatus("Database recreated. Refreshing data...");
                    loadAllData();
                    JOptionPane.showMessageDialog(LibraryApp.this, "Database recreated successfully.");
                } catch (Exception ex) {
                    showError(ex);
                    setStatus("Failed to recreate DB");
                }
            }
        }.execute();
    }

    private void executeSqlOnServer(String... statements) throws SQLException {
        // Connect to server (no specific DB) and run statements sequentially.
        try (Connection c = DriverManager.getConnection(DB_URL_SERVER, DB_USER, DB_PASS);
             Statement st = c.createStatement()) {
            for (String s : statements) {
                st.execute(s);
            }
        }
    }

    private void exportBooksCsv() {
        JFileChooser fc = new JFileChooser();
        fc.setDialogTitle("Save books CSV");
        if (fc.showSaveDialog(this) != JFileChooser.APPROVE_OPTION) return;
        java.io.File f = fc.getSelectedFile();
        setStatus("Exporting books...");
        new SwingWorker<Void,Void>() {
            protected Void doInBackground() throws Exception {
                List<Book> books = bookDAO.getAll();
                try (java.io.PrintWriter pw = new java.io.PrintWriter(f)) {
                    pw.println("id,title,author,isbn,total,available");
                    for (Book b : books) {
                        pw.printf("%d,%s,%s,%s,%d,%d%n",
                                b.getId(),
                                escapeCsv(b.getTitle()),
                                escapeCsv(b.getAuthor()),
                                escapeCsv(b.getIsbn()),
                                b.getTotalCopies(),
                                b.getAvailableCopies());
                    }
                }
                return null;
            }
            protected void done() {
                try { get(); setStatus("Export complete: " + f.getAbsolutePath()); JOptionPane.showMessageDialog(LibraryApp.this, "Export complete"); }
                catch (Exception ex) { showError(ex); setStatus("Export failed"); }
            }
        }.execute();
    }

    private String escapeCsv(String s) {
        if (s == null) return "";
        String out = s.replace("\"", "\"\"");
        if (out.contains(",") || out.contains("\"") || out.contains("\n")) return "\"" + out + "\"";
        return out;
    }

    private boolean isValidEmail(String email) {
        // Simple RFC-light check
        Pattern p = Pattern.compile("^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$");
        return p.matcher(email).matches();
    }
}
